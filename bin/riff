#!/usr/bin/env ruby

require 'slop'

opts = Slop::Options.new do |o|
  o.banner = <<-EOS
Usage: diff ... | riff
Colors diff and highlights what parts of changed lines have changed.

Git integration:
    git config --global pager.diff riff
    git config --global pager.show riff
EOS
  o.separator 'Options:'
  o.on '-h', '--help', 'Print this help' do
    puts o
    exit
  end
end

if $stdin.isatty
  puts opts
  exit
end

begin
  opts.parse(ARGV)
rescue Slop::Error => e
  STDERR.puts "ERROR: #{e}"
  STDERR.puts
  STDERR.puts opts
  exit 1
end

begin
  # Inspired by http://timelessrepo.com/making-ruby-gems
  begin
    require 'riff'
  rescue LoadError
    $LOAD_PATH.unshift File.join(__dir__, '..', 'lib')
    require 'riff'
  end
  require 'pager'

  include Pager

  refined = Riff.new().do_stream(STDIN)
  page(refined)
rescue => e
  STDERR.puts
  STDERR.puts e.to_s
  STDERR.puts e.backtrace.join("\n\t")
  STDERR.puts
  STDERR.puts 'Please report this to https://github.com/walles/riff/issues'
end
